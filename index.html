<script>
    // *** âš ï¸ å¿…é ˆï¼šWorkerã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã«ç½®ãæ›ãˆã¦ãã ã•ã„ âš ï¸ ***
    const WORKER_ENDPOINT_URL = "https://purple-sun-747c.ryuheifirebase.workers.dev/";
    const OWNER = "RiverTeacher";
    const REPO = "dousabo_img";
    // ***************************************************************

    const DROP_AREA = document.getElementById('drop-area');
    // ... (ãã®ä»–ã®å¤‰æ•°å®£è¨€ã¯å¤‰æ›´ãªã—)

    let selectedFile = null;
    // ... (handleFile ã¾ã§ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—)

    // Base64ã¸ã®å¤‰æ›ã¨Workersã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    function uploadImage() {
        if (!selectedFile) {
            MESSAGE_DIV.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
            return;
        }

        URL_OUTPUT.textContent = '';
        MESSAGE_DIV.textContent = 'ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ (WorkersçµŒç”±)...';
        UPLOAD_BTN.disabled = true;

        const reader = new FileReader();
        reader.onloadend = function() {
            // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã‹ã‚‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (data:image/...) ã‚’é™¤å»
            const base64Content = reader.result.split(',')[1];

            // Workerã¸é€ä¿¡ã™ã‚‹ãƒœãƒ‡ã‚£
            const requestBody = JSON.stringify({
                fileName: selectedFile.name,
                base64Content: base64Content // ãƒˆãƒ¼ã‚¯ãƒ³ã¯å«ã‚ãªã„ï¼
            });

            fetch(WORKER_ENDPOINT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // âš ï¸ ã“ã“ã«Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä¸è¦ âš ï¸
                },
                body: requestBody
            })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    // Workerã¾ãŸã¯GitHubã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
                    throw new Error(data.message || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
                return data;
            }))
            .then(data => {
                // GitHub APIã®å¿œç­”ã«ã¯ã€ã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ± (data.content) ãŒå«ã¾ã‚Œã¦ã„ã‚‹
                const path = data.content.path;
                // Pagesã§å…¬é–‹ã•ã‚Œã‚‹URLã‚’çµ„ã¿ç«‹ã¦ã‚‹ (ãƒ–ãƒ©ãƒ³ãƒåãŒ 'main' ã®å ´åˆ)
                const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${path}`;

                MESSAGE_DIV.textContent = `ğŸ‰ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼`;
                URL_OUTPUT.innerHTML = `
                    å…¬é–‹URL (CDN): <a href="${data.content.download_url}" target="_blank">${data.content.download_url}</a><br>
                    Raw URL: <a href="${rawUrl}" target="_blank">${rawUrl}</a>
                `;
                UPLOAD_BTN.disabled = false;
                selectedFile = null;
            })
            .catch(error => {
                MESSAGE_DIV.textContent = `âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}`;
                console.error('Upload Error:', error);
                UPLOAD_BTN.disabled = false;
            });
        };
        reader.readAsDataURL(selectedFile);
    }
</script>
