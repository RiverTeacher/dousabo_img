const OWNER = "RiverTeacher"; 
const REPO = "dousabo_img";
const BRANCH = "main"; // ã‚³ãƒŸãƒƒãƒˆå…ˆã®ãƒ–ãƒ©ãƒ³ãƒå

/**
 * HTTP POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
 * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰é€ã‚‰ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€GitHub APIã«ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚
 */
function doPost(e) {
  // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªã„å ´åˆã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ãªå ´åˆ
  if (!e || !e.postData || !e.postData.contents) {
    return createCorsResponse({ message: "Invalid request (no content)" }, 400);
  }
  
  try {
    const data = JSON.parse(e.postData.contents);
    const fileName = data.fileName;
    const base64Content = data.base64Content;
    
    // 1. PATã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å®‰å…¨ã«èª­ã¿è¾¼ã‚€
    const token = PropertiesService.getScriptProperties().getProperty('GITHUB_TOKEN');
    if (!token) {
        return createCorsResponse(
            { message: "Server configuration error: GitHub Token not set." }, 
            500
        );
    }
    
    // 2. GitHub APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æº–å‚™
    const timestamp = new Date().getTime();
    const path = `images/${timestamp}_${fileName}`;
    const githubApiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
    
    const payload = {
      message: `feat(upload): Add image ${fileName} via GAS`,
      content: base64Content,
      branch: BRANCH
    };
    
    const options = {
      method: 'put',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json',
        'User-Agent': OWNER
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true // ã‚¨ãƒ©ãƒ¼å¿œç­”ã‚’ã‚­ãƒ£ãƒƒãƒã™ã‚‹ãŸã‚ã«å¿…é ˆ
    };
    
    // 3. GitHub APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
    const response = UrlFetchApp.fetch(githubApiUrl, options);
    const responseCode = response.getResponseCode();
    const responseBody = response.getContentText();
    
    // 4. çµæžœã®è¿”å´
    if (responseCode >= 200 && responseCode < 300) {
      return createCorsResponse(JSON.parse(responseBody), 200);
    } else {
      // GitHubã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼å¿œç­”ã‚’è¿”ã™
      const errorBody = JSON.parse(responseBody);
      return createCorsResponse(
          { 
              message: `GitHub API Error (${responseCode}): ${errorBody.message || 'Unknown error'}`,
              status: responseCode
          }, 
          responseCode
      );
    }

  } catch (e) {
    return createCorsResponse(
        { message: `Internal Error: ${e.message}`, status: 500 }, 
        500
    );
  }
}

/**
 * HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚OPTIONS (Preflight) ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’å…¼ã­ã¾ã™ã€‚
 */
function doGet() {
  // OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç† (CORS Preflight)
  // GETã¨ã—ã¦å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€CORSãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ã‚’è¿”ã—ã¾ã™ã€‚
  return createCorsResponse(null, 200);
}

/**
 * JSONå¿œç­”ã‚’ä½œæˆã—ã€CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºå®Ÿã«è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‚
 * @param {Object} content è¿”å´ã™ã‚‹JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚nullã®å ´åˆã¯CORSãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ã‚’è¿”ã™ã€‚
 * @param {number} status å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆGASã¯å¸¸ã«200ã‚’è¿”ã™ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒœãƒ‡ã‚£ã®statusã‚’ç¢ºèªã™ã‚‹ï¼‰
 * @returns {GoogleAppsScript.Content.TextOutput} CORSãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã®å¿œç­”ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function createCorsResponse(content, status) {
  let output;
  
  if (content === null) {
      // doGet/OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆ
      output = ContentService.createTextOutput('');
  } else {
      // doPostãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆ
      // æˆåŠŸæ™‚/ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’JSONãƒœãƒ‡ã‚£ã«è¿½åŠ ï¼ˆGASã®åˆ¶ç´„å¯¾ç­–ï¼‰
      if (typeof content === 'object') {
          content.status = status;
      }
      output = ContentService.createTextOutput(JSON.stringify(content))
        .setMimeType(ContentService.MimeType.JSON);
  }
  
  // ðŸ’¡ CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½è¨˜ã™ã‚‹ (GASã§CORSã‚’ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã®æœ€ã‚‚ç¢ºå®Ÿãªæ–¹æ³•)
  output.append(`\n\nAccess-Control-Allow-Origin: *`);
  output.append(`\nAccess-Control-Allow-Methods: POST, OPTIONS`);
  output.append(`\nAccess-Control-Allow-Headers: Content-Type`);
  output.append(`\nAccess-Control-Max-Age: 86400`); // ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆçµæžœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

  return output;
}
